# 複合条件の実装方針

## 概要

複数の設問ノードの回答結果を組み合わせて、特定の条件を満たした場合のみ遷移する「複合条件」機能の実装方針をまとめる。

## 前提条件

複合条件を実装する前に、以下の機能が必要：

1. **設問カテゴリの設定** - 各ノードに設問タイプを設定できる機能
   - SA（Single Answer）: 単一選択
   - MA（Multiple Answer）: 複数選択
   - FA（Free Answer）: 自由入力
   - NA（Numeric Answer）: 数値入力

## 現在の実装状態

`AddConditionDialog.tsx` と `page.tsx` に複合条件の基盤となるコードを実装済み：

### AddConditionDialog.tsx
- `ConditionDefinition` インターフェース
- `AddConditionResult` インターフェース（`stateNode` プロパティを含む）
- 複合条件選択UIの基本構造（条件ノードに対して Yes/No を選択）
- 状態ノードID/ラベルの自動生成ロジック

### page.tsx
- 状態ノード判定関数 `isStateNode()`
- `displayNodes` / `displayEdges`（状態ノードをサイドパネルから除外）
- `conditionNodes`（ひし形ノードの一覧）
- `handleAddCondition` 内の状態ノード自動生成ロジック

## 複合条件の動作フロー

```
1. ユーザーがノードをクリック
2. ダイアログで「複合条件を使用」にチェック
3. 2つ以上の条件ノードに対して条件を設定
4. 接続先ノードを選択して「追加」
5. システムが自動で：
   - 状態ノード（_state_xxx）を作成
   - 各条件ノード → 状態ノードへのエッジを追加
   - 状態ノード → 接続先ノードへのエッジを追加
```

## 設問カテゴリごとの複合条件の扱い

### SA（単一選択）
- 選択肢から1つを選ぶ
- 複合条件: 「選択肢Aを選んだ」AND「選択肢Bを選んだ」など

### MA（複数選択）
- 複数の選択肢を選べる
- 複合条件: 「選択肢Aを含む」「選択肢Aを含まない」「選択肢Aのみ」など

### FA（自由入力）
- テキスト入力
- 複合条件: 「特定のキーワードを含む」「空でない」など（将来的に正規表現対応も検討）

### NA（数値入力）
- 数値を入力
- 複合条件: 「X以上」「X以下」「X〜Yの範囲」「Xと等しい」など

## 実装タスク

### Phase 1: 設問カテゴリの設定（先に実装）

1. [ ] `FlowchartNode` 型に `questionType` プロパティを追加
2. [ ] ノードエディターに設問タイプ選択UIを追加
3. [ ] 設問タイプに応じたノード形状/色の変更（オプション）

### Phase 2: 複合条件の本格実装（カテゴリ設定完了後）

1. [ ] 設問カテゴリに応じた条件入力UIの実装
   - SA: 選択肢のドロップダウン
   - MA: チェックボックス + 条件タイプ（含む/含まない/のみ）
   - FA: テキスト入力 + マッチタイプ（完全一致/部分一致/正規表現）
   - NA: 数値入力 + 比較演算子
2. [ ] 条件の評価ロジック実装
3. [ ] 状態ノードのラベル生成ロジックの改善
4. [ ] 既存の状態ノードとの重複チェック強化

## 状態ノードの命名規則

```
_state_{条件1ノードID}_{条件1値}_{条件2ノードID}_{条件2値}_...
```

例: `_state_Q1_Yes_Q2_No` = Q1でYes、Q2でNoを選択した状態

## 注意事項

- 状態ノードはサイドパネルには表示しない（`_state_` プレフィックスで判定）
- 状態ノードは六角形で表示
- 同一の複合条件を持つ状態ノードが既に存在する場合は再利用
- 条件ノード（ひし形）のみが複合条件の対象となる（現在の実装）
  - 将来的には設問カテゴリを持つノード全般に拡張
